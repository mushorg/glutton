package iscsi

import (
	"testing"

	"github.com/stretchr/testify/require"
)

func TestHandleISCSIMessage(t *testing.T) {

	data := []byte{
		0x03, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x40, 0x00, 0x01, 0x37,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x49, 0x6e, 0x69, 0x74,
		0x69, 0x61, 0x74, 0x6f, 0x72, 0x4e, 0x61, 0x6d, 0x65, 0x3d, 0x69, 0x71,
		0x6e, 0x2e, 0x31, 0x39, 0x39, 0x31, 0x2d, 0x30, 0x35, 0x2e, 0x63, 0x6f,
		0x6d, 0x2e, 0x6d, 0x69, 0x63, 0x72, 0x6f, 0x73, 0x6f, 0x66, 0x74, 0x3a,
		0x6e, 0x6d, 0x61, 0x70, 0x5f, 0x69, 0x73, 0x63, 0x73, 0x69, 0x5f, 0x70,
		0x72, 0x6f, 0x62, 0x65, 0x00, 0x53, 0x65, 0x73, 0x73, 0x69, 0x6f, 0x6e,
		0x54, 0x79, 0x70, 0x65, 0x3d, 0x44, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x65,
		0x72, 0x79, 0x00, 0x41, 0x75, 0x74, 0x68, 0x4d, 0x65, 0x74, 0x68, 0x6f,
		0x64, 0x3d, 0x4e, 0x6f, 0x6e, 0x65, 0x00, 0x00,
	}
	res, _, _ := handleISCSIMessage(data)

	expectedRes := iscsiRes{
		Opcode:  0x23,
		Flags:   0x00,
		TaskTag: 0,
		Data:    0,
		CID:     20381696,
		LUN:     65537,
		Status:  0,
	}

	if res != expectedRes {
		require.Equal(t, expectedRes, res, "Expected response does not match the actual response")
	}

}

// Response: {Opcode:35 Flags:0 TaskTag:0 Data:0 CID:20381696 LUN:65537 Status:0}
